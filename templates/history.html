{% extends 'base.html' %}

{% block title %}History - SpotScrape{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-5 fw-bold mb-2">
                <i class="bi bi-clock-history me-3"></i>Search History
            </h1>
            <p class="text-secondary">Your recent Spotify data extractions</p>
        </div>
        <div class="d-flex gap-2">
            <button onclick="exportHistory()" class="btn btn-outline-light">
                <i class="bi bi-download me-2"></i>Export
            </button>
            <button onclick="clearHistory()" class="btn btn-danger">
                <i class="bi bi-trash me-2"></i>Clear All
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="feature-card p-4 mb-4">
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="input-group">
                    <span class="input-group-text bg-transparent border-secondary">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchHistory" placeholder="Search your history..." onkeyup="filterHistory()">
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <select class="form-select" id="filterType" onchange="filterHistory()">
                    <option value="all">All Types</option>
                    <option value="track">Tracks</option>
                    <option value="album">Albums</option>
                    <option value="playlist">Playlists</option>
                    <option value="artist">Artists</option>
                </select>
            </div>
        </div>
    </div>

    {% if items %}
    <!-- History Grid -->
    <div class="row" id="historyGrid">
        {% for item in items %}
        <div class="col-lg-6 mb-4 history-item" data-title="{{ item.title.lower() }}" data-description="{{ item.description.lower() }}" data-type="{% if 'track' in item.spotify_url %}track{% elif 'album' in item.spotify_url %}album{% elif 'playlist' in item.spotify_url %}playlist{% elif 'artist' in item.spotify_url %}artist{% else %}unknown{% endif %}">
            <div class="feature-card h-100 p-3">
                <div class="row g-0 h-100">
                    <div class="col-4">
                        <img src="{{ item.image_url }}" alt="Cover" class="img-fluid w-100 h-100" style="object-fit: cover; min-height: 120px;">
                    </div>
                    <div class="col-8">
                        <div class="card-body p-3 d-flex flex-column h-100">
                            <div class="mb-2">
                                {% if 'track' in item.spotify_url %}
                                    <span class="badge bg-success">Track</span>
                                {% elif 'album' in item.spotify_url %}
                                    <span class="badge bg-primary">Album</span>
                                {% elif 'playlist' in item.spotify_url %}
                                    <span class="badge bg-warning">Playlist</span>
                                {% elif 'artist' in item.spotify_url %}
                                    <span class="badge bg-info">Artist</span>
                                {% endif %}
                                <small class="text-secondary ms-2">{{ item.date.strftime('%b %d, %Y') }}</small>
                            </div>
                            <h6 class="fw-bold mb-2">{{ item.title }}</h6>
                            <p class="text-secondary small mb-3 flex-grow-1">{{ item.description[:80] }}{% if item.description|length > 80 %}...{% endif %}</p>
                            <div class="d-flex gap-2 align-items-center justify-content-center">
                                <a href="{{ item.spotify_url }}?utm_source=spotscrape" target="_blank" class="btn btn-sm btn-outline-light padding-12 flex-grow-1 text-center">
                                    <i class="bi bi-spotify me-1"></i>Open
                                </a>
                                <button onclick="reExtract('{{ item.spotify_url }}')" class="btn btn-sm btn-success">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button onclick="deleteHistoryItem({{ item.id }}, this)" class="btn btn-sm btn-outline-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Load More Button -->
    <div class="text-center mt-4">
        <button class="btn btn-outline-light" onclick="loadMoreHistory()">
            <i class="bi bi-arrow-down-circle me-2"></i>Load More
        </button>
    </div>
    
    {% else %}
    <!-- Empty State -->
    <div class="feature-card p-5 text-center">
        <div class="mb-4">
            <i class="bi bi-clock-history" style="font-size: 4rem; color: var(--text-secondary);"></i>
        </div>
        <h3 class="fw-bold mb-3">No History Yet</h3>
        <p class="text-secondary mb-4">Start extracting Spotify data to see your history here.</p>
        <a href="/" class="btn btn-success">
            <i class="bi bi-search me-2"></i>Start Extracting
        </a>
    </div>
    {% endif %}
</div>

<script>
function filterHistory() {
    const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
    const filterType = document.getElementById('filterType').value;
    const historyItems = document.querySelectorAll('.history-item');
    
    historyItems.forEach(item => {
        const title = item.dataset.title;
        const description = item.dataset.description;
        const type = item.dataset.type;
        
        const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
        const matchesType = filterType === 'all' || type === filterType;
        
        if (matchesSearch && matchesType) {
            item.style.display = 'block';
            item.classList.add('fade-in');
        } else {
            item.style.display = 'none';
        }
    });
}

function reExtract(url) {
    // Redirect to appropriate page based on URL type
    if (url.includes('/playlist/')) {
        window.location.href = `/playlist?url=${encodeURIComponent(url)}`;
    } else {
        window.location.href = `/?url=${encodeURIComponent(url)}`;
    }
}

function exportHistory() {
    const historyData = [];
    document.querySelectorAll('.history-item').forEach(item => {
        const card = item.querySelector('.card-body');
        const title = card.querySelector('h6').textContent;
        const description = card.querySelector('p').textContent;
        const type = item.dataset.type;
        const date = card.querySelector('small').textContent;
        const url = card.querySelector('a').href;
        
        historyData.push({ title, description, type, date, url });
    });
    
    const dataStr = JSON.stringify(historyData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'spotscrape_history.json';
    link.click();
    URL.revokeObjectURL(url);
    
    showToast('History exported successfully!', 'success');
}

function loadMoreHistory() {
    // Mock function - in real app, this would load more items from server
    showToast('No more items to load', 'info');
}

async function deleteHistoryItem(itemId, button) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    
    const originalHtml = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    button.disabled = true;
    
    try {
        const response = await fetch(`/delete-history-item/${itemId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            const historyItem = button.closest('.history-item');
            historyItem.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => {
                historyItem.remove();
                showToast('Item deleted successfully', 'success');
            }, 300);
        } else {
            throw new Error('Failed to delete item');
        }
    } catch (error) {
        showToast('Failed to delete item', 'error');
        button.innerHTML = originalHtml;
        button.disabled = false;
    }
}

// Pre-fill URL if provided in query params
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const url = urlParams.get('url');
    if (url) {
        document.getElementById('spotifyUrl').value = url;
        fetchData();
    }
});
</script>
{% endblock %}